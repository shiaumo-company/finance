<h3>InsertData</h3>
@page "/InsertData"
@using System;
@using System.Data;
@using System.Data.SqlClient;
@using DBS.Data
@using DBS.Pages;
@using DBS.Services
@inject IAlertService AlertService
@inject NavigationManager NavManager
@inject DataVersionService DataVersionService

<head>
	<link href="styles/site.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css" integrity="sha512-XNkCjx/a0lED2ktq3KaBz1v62cxVvLU9y+gZLnhyl4+btRhe+uxLw6J/9M+k2JvZFsX5v9FxVjH4D2u5JUdw==">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8" crossorigin="anonymous"></script>

</head>
<AuthorizeView>
	<Authorized>
		 <table class="table" style="text-align:right; margin-top:20px;" >
			<thead>
				<tr>
					<td style="height: 30px; width :100px;">交易日期</td>
					<td>		
						<input style="height: 30px; width :175px;"type="date" value=@todatee @onchange="EditDateChange " >
					</td>
				</tr>
				<tr>
					<td>銀行</td>
						<select style="height: 30px; width :175px;" @onchange="BankChange">
						<option value="" disabled selected>請選擇銀行</option>
						@foreach (var banks in BankData.GetBankList())
						{
							@if (DataVersionService.DataVersion != 1)//如果有變更則要重新去資料庫抓資料，即時更新
							{
								AccountRepair[] updatedData = UpdateAccountRepairALL();
								var distinctRepairs = updatedData.Where(repairs => repairs.baccountBankNo == banks.BankCode.ToString().Substring(0, 3))
								.GroupBy(item => item.baccountNo)
								.Select(group => group.First()).ToArray();
								if (distinctRepairs.Any())
								{
									<option value=@banks.BankCode >@banks.BankName</option>
								}
							}
							else
							{
								var distinctRepairs = ServerData.m_AccountRepairS.Where(repairs => repairs.baccountBankNo == banks.BankCode.ToString().Substring(0, 3))
								.GroupBy(item => item.baccountNo)
								.Select(group => group.First()).ToArray();
								if (distinctRepairs.Any())
								{
									<option value=@banks.BankCode >@banks.BankName</option>
								}
							}
						}
						</select>
						<td>我的帳號</td>
						<select style="height: 30px;width :175px;" @onchange="AccountChange">
						<option value="" selected >請選擇帳號</option>
						@if (DataVersionService.DataVersion != 1)
						{
							AccountRepair[] updatedData = UpdateAccountRepairALL();
							@foreach (var account in updatedData.Where(item => item.baccountBankNo == @bankCode)
							.GroupBy(item => new { item.baccountNo })
							.Select(group => group.First()).ToArray())
							{
								<option value="@account.baccountNo" >@account.baccountNo</option>
							}
						}
						else
						{
							if (m_AccountRepairS == null)
							{
								m_AccountRepairS = ServerData.m_AccountRepairS.ToArray();
								@foreach (var account in m_AccountRepairS.Where(item => item.baccountBankNo == @bankCode)
								.GroupBy(item => new { item.baccountNo })
								.Select(group => group.First()).ToArray())
								{
									<option value="@account.baccountNo" >@account.baccountNo</option>
								}
							}
							else
							{
								m_AccountRepairS = Array.Empty<AccountRepair>();
								m_AccountRepairS = ServerData.m_AccountRepairS.ToArray();
								@foreach (var account in m_AccountRepairS.Where(item => item.baccountBankNo == @bankCode)
								.GroupBy(item => new { item.baccountNo })
								.Select(group => group.First()).ToArray())
								{
									<option value="@account.baccountNo" >@account.baccountNo</option>
								}
							}
						}
						</select>
						<td>付款方式</td>
						<td>		
							<select style="height: 30px;width :175px;" @onchange="MoneyChange" >
							<option value="" disabled selected>請選擇方式</option>
							<option >現金</option>
							<option >支票</option>
							</select>
						</td>
						<td>備註</td>
						<td >
							<input style="height:30px; width:175px;" id="remark" type="text" asp-for="remark" @bind="remark" placeholder="備註"/>
						</td>
					</tr>
					<tr>
						<td>收入</td>
						<td>		
							<input style="height: 30px;width :175px;" id="accountIn" type="text" asp-for="accountIn" @bind="accountIn"/>
						</td>
						<td>支出</td>
						<td>	
							<input style="height: 30px;width :175px;" id="accountOut" type="text" asp-for="accountOut" @bind="accountOut"/>
						</td>
						<td>對方帳號</td>
						<td>		
							<input style="height: 30px;width :175px;" id="accountOtherNo" type="text" asp-for="accountOtherNo" @bind="accountOtherNo" placeholder="對方帳號"/>
						</td>
					</tr>
			</thead>
			<tbody>
				<button @onclick="OnClickAdd">新增</button>
			</tbody>
		</table>
		 <table class="table" style="text-align:right; margin-top:20px;" >
			<thead>
				<tr>
					<th style="text-align:center">交易日期</th>
					<th>帳號代碼</th>
					<th>我的帳號</th>
					<th>方式</th>
					<th>收入</th>
					<th>支出</th>
					<th>結存餘額</th>
					<th>對方行帳號</th>
					<th>備註</th>
				</tr>
			</thead>
			<tbody>
				@if (m_NewAccountS != null)
				{
					@foreach (var (account, i) in m_NewAccountS.Select((account, i) => (account, i)))
					{
						<td style="text-align:center">@account.baccountDate.ToShortDateString()</td>
						<td>@account.baccountBankNo @account.baccountBank<br />
							@foreach (var repair in ServerData.m_AccountRepairS.Where(r => r.baccountNo == account.baccountNo))
							{
								<span>@repair.baccountBranchNo @repair.baccountBranch</span>
								<br />
							}
						</td>
							<td>@account.baccountNo</td>
							<td>@account.baccountType</td>
							<td>@account.baccountIn</td>
							<td>@account.baccountOut</td>
							<td>@account.baccountTotal</td>
							<td>@account.baccountOtherNo</td>
							<td>@account.bremark</td>
					}
				}
			</tbody>
		</table>
	</Authorized>
</AuthorizeView>
@code {

	DateTime datee, accountInsert;
	string datee2, myAccount, accountDate, accountBank, accountBankNo, accountNo, accountType, accountIn, accountOut, accountTotal, accountOtherNo, remark;
	private NewAccount[] m_NewAccountS;
	private AccountRepair[] m_AccountRepairS;
	string todatee = DateTime.Today.ToString("yyyy-MM-dd");

	DateTime editDate;
	public void EditDateChange(ChangeEventArgs e)
	{
		editDate = Convert.ToDateTime(e.Value);
	}

	string money;
	public void MoneyChange(ChangeEventArgs e)
	{
		money = e.Value.ToString();
	}
	string bank, bankName, bankCode;
	public void BankChange(ChangeEventArgs e)
	{
		bank = e.Value.ToString();
		bankName = e.Value.ToString().Substring(3);
		bankCode = e.Value.ToString().Substring(0, 3);
	}
	string bank2, bankName2, bankCode2;
	public void BankChangeOther(ChangeEventArgs e)
	{
		bank2 = e.Value.ToString();
		bankName2 = e.Value.ToString().Substring(3);
		bankCode2 = e.Value.ToString().Substring(0, 3);
	}
	string account;
	public void AccountChange(ChangeEventArgs e)
	{
		account = e.Value?.ToString();
	}
	DateTime beginDate;
	public void BeginDateChange(ChangeEventArgs e)
	{
		beginDate = Convert.ToDateTime(e.Value);
	}
	DateTime endDate;
	public void EndDateChange(ChangeEventArgs e)
	{
		endDate = Convert.ToDateTime(e.Value);
	}


	private NewAccount[] m_NewAccountRecordS;
	public AccountRepair[] UpdateAccountRepairALL()
	//專門給選擇銀行後跳出對應帳戶用的更新資料(有時候可能會先使用銀行維護去新增資料，這時候就要用他嚕)
	{
		// 將 NewAccount[] 陣列轉換為 List<NewAccount>
		List<AccountRepair> newList = ServerData.m_AccountRepairS.ToList();
		// 新資料列表
		List<AccountRepair> newDataList = GetAccountRepair();
		// 使用 LINQ 的 Except 方法排除已經存在的資料
		newDataList = newDataList.Except(newList).ToList();
		// 使用 AddRange 將新資料列表添加到現有的列表中
		newList.AddRange(newDataList);
		// 將結果轉換回陣列
		// 將新資料列表添加到現有的 m_NewAccountS 中
		m_AccountRepairS = newList.ToArray();
		return m_AccountRepairS;
	}

	string kkk = "";
	public DataSet dataset = new DataSet();
	public List<AccountRepair> GetAccountRepair()//再次抓取資料
	{

		List<AccountRepair> newDataList = new List<AccountRepair>();
		//SqlConnection sqlconnection = new SqlConnection("Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022");
		string connectionString = "Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022";
		string SQLString = "SELECT * FROM NewAccountRepair ";
		dataset = new DataSet();
		using (SqlConnection connection = new SqlConnection(connectionString))
		{
			using (SqlCommand command = new SqlCommand(SQLString, connection))
			{
				try
				{
					connection.Open();

					using (SqlDataReader reader = command.ExecuteReader())
					{
						while (reader.Read())
						{
							AccountRepair newData = new AccountRepair
								{
									// 這裡的屬性賦值根據您的資料表結構進行調整
									baccountBank = reader.GetString(reader.GetOrdinal("accountBank")),
									baccountBankNo = reader.GetString(reader.GetOrdinal("accountBankNo")),
									baccountBranch = reader.GetString(reader.GetOrdinal("accountBranch")),
									baccountBranchNo = reader.GetString(reader.GetOrdinal("accountBranchNo")),
									baccountNo = reader.GetString(reader.GetOrdinal("accountNo")),
									baccountAddress = reader.GetString(reader.GetOrdinal("accountAddress")),
									baccountInitialMoney = reader.IsDBNull(reader.GetOrdinal("accountInitialMoney")) ? 0 : reader.GetDecimal(reader.GetOrdinal("accountInitialMoney")),
									bremark = reader.IsDBNull(reader.GetOrdinal("remark")) ? "" : reader.GetString(reader.GetOrdinal("remark")),
									baccountInsert = reader.IsDBNull(reader.GetOrdinal("accountInsert")) ? DateTime.MinValue : reader.GetDateTime(reader.GetOrdinal("accountInsert")),
									baccountUpdate = reader.IsDBNull(reader.GetOrdinal("accountUpdate")) ? DateTime.MinValue : reader.GetDateTime(reader.GetOrdinal("accountUpdate")),

									// 其他屬性...
								};
							newDataList.Add(newData);
						}
					}
				}
				catch (Exception ex)
				{
					kkk += ex.Message;
				}
			}
		}
		return newDataList;
	}

	public void OnClickAdd(MouseEventArgs e)
	{
		if (editDate == DateTime.MinValue)
		{
			AlertService.Error("請選擇交易日期");
			return; // 在這裡返回，結束函數執行
		}
		if (string.IsNullOrEmpty(bank))
		{
			AlertService.Error("請選擇銀行");
			return;
		}
		if (string.IsNullOrEmpty(account))
		{
			AlertService.Error("請選擇帳號");
			return;
		}
		if (string.IsNullOrEmpty(money))
		{
			AlertService.Error("請選擇付款方式");
			return;
		}
		if (string.IsNullOrEmpty(accountIn) && string.IsNullOrEmpty(accountOut))
		{
			AlertService.Error("請輸入收入或者支出");
			return;
		}
		if (string.IsNullOrEmpty(accountOtherNo))
		{
			AlertService.Error("請輸入對方帳號");
			return;
		}
		if (DataVersionService.DataVersion != 1)//若版本有更新，例如新增、修改、刪除....
		{
			NewAccount[] updatedData = UpdateNewDataALL2();
			updatedData = updatedData.Where(item => item.baccountNo == account) // 根據帳號篩選
						.GroupBy(item => item.baccountNo) // 按帳號分組
						.Select(group => group.OrderBy(item => item.baccountBank)
								.ThenBy(item => item.baccountNo)
								.ThenBy(item => item.baccountDate)
								.ThenBy(item => item.baccountInsert))
						.SelectMany(sortedGroup => sortedGroup)
						.ToArray();
			if (updatedData.Length == 0)//若該帳號沒有使用過直接新增
			{
				HandleEmptyArray();

			}
			else if (updatedData.Length == 1) //若該帳號只有一條
			{
				HandleArrayWithOneItem();
			}
			else //若該帳號大於2條
			{
				HandleArrayWithMoreThanOneItem();//若帳號有兩條以上
			}
		}
		else
		{
			m_NewAccountS = ServerData.m_NewAccountS.Where(item => item.baccountNo == account) // 根據帳號篩選
						.GroupBy(item => item.baccountNo) // 按帳號分組
						.Select(group => group.OrderBy(item => item.baccountBank)
								.ThenBy(item => item.baccountNo)
								.ThenBy(item => item.baccountDate)
								.ThenBy(item => item.baccountInsert))
						.SelectMany(sortedGroup => sortedGroup)
						.ToArray();
			if (m_NewAccountS.Length == 0)//若該帳號沒有使用過直接新增
			{
				HandleEmptyArray();

			}
			else if (m_NewAccountS.Length == 1) //若該帳號只有一條
			{
				HandleArrayWithOneItem();
			}
			else //若該帳號大於2條
			{
				HandleArrayWithMoreThanOneItem();//若帳號有兩條以上
			}
		}
	}
	public void HandleEmptyArray()//若該帳號沒有使用過直接新增
	{
		datee2 = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");//加入日期

		string SQLString = "INSERT INTO dbo.NewAccountInfo ([accountDate],[accountBank],[accountBankNo],[accountBranch],[accountBranchNo],[accountNo],[accountType],[accountIn],[accountOut],[accountTotal],[accountOtherNo],[accountAddress],[remark], [accountInsert],[accountUpdate]) VALUES (@editDate,@bankName,@bankCode,@accountBranch,@accountBranchNo,@accountNo,@accountType,@accountIn,@accountOut,@toto,@accountOtherNo,@accountAddress,@remark ,@accountInsert,@accountUpdate)";
		SqlConnection sqlconnection = new SqlConnection("Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022");
		DataSet dataSet_up = new DataSet();
		m_AccountRepairS = ServerData.m_AccountRepairS.Where(item => item.baccountNo == account && item.baccountBankNo == bankCode).ToArray();
		var repairbranch = m_AccountRepairS[0];
		string r_b = repairbranch.baccountBranch;
		string r_b_n = repairbranch.baccountBranchNo;
		string r_b_a = repairbranch.baccountAddress;
		decimal latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
		decimal latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
		decimal toto = latestIn - latestOut;
		if (sqlconnection.State == System.Data.ConnectionState.Closed)
		{
			sqlconnection.Open();
			SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
			sqlcommand.Parameters.AddWithValue("@editDate", editDate);//交易日期
			sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
			sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
			sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);
			sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//銀行代碼
			sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
			sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
			sqlcommand.Parameters.AddWithValue("@accountIn", (object)accountIn ?? 0);//收入
			sqlcommand.Parameters.AddWithValue("@accountOut", (object)accountOut ?? 0);//支出
			sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
			sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
			sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);
			sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
			sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
			sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
			int rowsAffected = sqlcommand.ExecuteNonQuery();
			if (rowsAffected > 0)
			{
				AlertService.Success($"成功新增{rowsAffected}條");
				myAccount = "";//我的帳號
				accountOut = "";
				accountIn = "";
				accountOtherNo = "";
				DataVersionService.IncrementDataVersion();
			}
			else
			{
				AlertService.Error("更新失敗");
			}
			SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
			sqlTransaction.Commit();
		}
		UpdateHandleEmptyArray(DateTime.Parse(datee2));
	}

	public void HandleArrayWithOneItem()//若該帳號只有一條新增
	{
		string SQLString = "INSERT INTO dbo.NewAccountInfo ([accountDate],[accountBank],[accountBankNo],[accountBranch],[accountBranchNo],[accountNo],[accountType],[accountIn],[accountOut],[accountTotal],[accountOtherNo],[accountAddress],[remark], [accountInsert],[accountUpdate]) VALUES (@accountDate,@bankName,@bankCode,@accountBranch,@accountBranchNo,@accountNo,@accountType,@accountIn,@accountOut,@toto,@accountOtherNo,@accountAddress,@remark ,@accountInsert,@accountUpdate)";
		SqlConnection sqlconnection = new SqlConnection("Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022");
		DataSet dataSet_up = new DataSet();
		if (DataVersionService.DataVersion != 1)
		{
			NewAccount[] updatedData = UpdateNewDataALL2();
			updatedData = updatedData.Where(item => item.baccountNo == account) // 根據帳號篩選
			.GroupBy(item => item.baccountNo) // 按帳號分組
			.Select(group => group.OrderBy(item => item.baccountBank)
								.ThenBy(item => item.baccountNo)
								.ThenBy(item => item.baccountDate)
								.ThenBy(item => item.baccountInsert))
			.SelectMany(sortedGroup => sortedGroup).ToArray();
			m_AccountRepairS = ServerData.m_AccountRepairS.Where(item => item.baccountNo == account && item.baccountBankNo == bankCode).ToArray();
			var repairbranch = m_AccountRepairS[0];
			string r_b = repairbranch.baccountBranch;
			string r_b_n = repairbranch.baccountBranchNo;
			string r_b_a = repairbranch.baccountAddress;
			var latestRecord = updatedData[0];
			if (latestRecord.baccountDate == editDate)//如果日期一樣
			{
				DateTime a = latestRecord.baccountDate;
				decimal latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
				decimal latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
				decimal secondTotal = (updatedData[0].baccountIn - updatedData[0].baccountOut);
				decimal toto = secondTotal + latestIn - latestOut;
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
				}
			}
			else if (latestRecord.baccountDate > editDate)//最舊
			{
				decimal latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
				decimal latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
				decimal toto = latestIn - latestOut;
				string accountinsert = datee.ToString("yyyy-MM-dd HH:mm:ss");
				DateTime a = latestRecord.baccountDate;
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼	
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增當前{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					HandleArrayWithOneItemUpdate(latestIn, latestOut);
					UpdateHandleEmptyArray(DateTime.Parse(datee2));
				}
			}
			else//新資料為最新
			{
				DateTime a = latestRecord.baccountDate;
				decimal latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
				decimal latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
				decimal secondTotal = (updatedData[0].baccountIn - updatedData[0].baccountOut);
				decimal toto = secondTotal + latestIn - latestOut;
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
				}
			}
		}
		else
		{
			m_NewAccountS = ServerData.m_NewAccountS.Where(item => item.baccountNo == account) // 根據帳號篩選
			.GroupBy(item => item.baccountNo) // 按帳號分組
			.Select(group => group.OrderBy(item => item.baccountBank)
								.ThenBy(item => item.baccountNo)
								.ThenBy(item => item.baccountDate)
								.ThenBy(item => item.baccountInsert))
			.SelectMany(sortedGroup => sortedGroup).ToArray();
			var latestRecord = m_NewAccountS[0];
			m_AccountRepairS = ServerData.m_AccountRepairS.Where(item => item.baccountNo == account && item.baccountBankNo == bankCode).ToArray();
			var repairbranch = m_AccountRepairS[0];
			string r_b = repairbranch.baccountBranch;
			string r_b_n = repairbranch.baccountBranchNo;
			string r_b_a = repairbranch.baccountAddress;
			if (latestRecord.baccountDate == editDate)//如果日期一樣
			{
				DateTime a = latestRecord.baccountDate;
				decimal latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
				decimal latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
				decimal secondTotal = (m_NewAccountS[0].baccountIn - m_NewAccountS[0].baccountOut);
				decimal toto = secondTotal + latestIn - latestOut;
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼	
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址		
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
				}
			}
			else if (latestRecord.baccountDate > editDate)//最舊
			{
				decimal latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
				decimal latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
				decimal toto = latestIn - latestOut;
				string accountinsert = datee.ToString("yyyy-MM-dd HH:mm:ss");
				DateTime a = latestRecord.baccountDate;
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增當前{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					HandleArrayWithOneItemUpdate(latestIn, latestOut);
					UpdateHandleEmptyArray(DateTime.Parse(datee2));
				}
			}
			else//新資料為最新
			{
				DateTime a = latestRecord.baccountDate;
				decimal latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
				decimal latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
				decimal secondTotal = (m_NewAccountS[0].baccountIn - m_NewAccountS[0].baccountOut);
				decimal toto = secondTotal + latestIn - latestOut;
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
				}
			}
		}
	}

	public void HandleArrayWithOneItemUpdate(decimal latestIn, decimal latestOut)//若該帳號只有一條ㄉ更新
	{
		SqlConnection sqlconnection = new SqlConnection("Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022");
		DataSet dataSet_up = new DataSet();
		decimal toto = latestIn - latestOut;
		if (DataVersionService.DataVersion != 1)
		{
			NewAccount[] updatedData = UpdateNewDataALL2();
			updatedData = updatedData.Where(item => item.baccountNo == account) // 根據帳號篩選
			.GroupBy(item => item.baccountNo) // 按帳號分組
			.Select(group => group.OrderBy(item => item.baccountBank)
								.ThenBy(item => item.baccountNo)
								.ThenBy(item => item.baccountDate)
								.ThenBy(item => item.baccountInsert))
			.SelectMany(sortedGroup => sortedGroup).ToArray();
			var latestRecord2 = updatedData[0];
			if (latestRecord2.baccountDate == editDate)//最舊
			{
				string SQLString2 = "UPDATE dbo.NewAccountInfo SET [accountTotal] = @toto  WHERE   [accountBankNo] =@bank AND [accountInsert]= @accountInsert ";
				m_NewAccountRecordS = updatedData.Where(item => item.baccountDate > editDate).ToArray();
				foreach (var oldRecord in m_NewAccountRecordS)
				{
					decimal secondIn = oldRecord.baccountIn;
					decimal secondOut = oldRecord.baccountOut;
					decimal toto1 = (latestIn - latestOut + secondIn - secondOut);
					if (sqlconnection.State == System.Data.ConnectionState.Closed)
					{
						sqlconnection.Open();
						SqlCommand sqlcommand = new SqlCommand(SQLString2, sqlconnection);
						sqlcommand.Parameters.Clear();
						sqlcommand.Parameters.AddWithValue("@accountInsert", oldRecord.baccountInsert);//交易日期
						sqlcommand.Parameters.AddWithValue("@bank", bankCode);//銀行
						sqlcommand.Parameters.AddWithValue("@toto", latestIn - latestOut + secondIn - secondOut);//餘額
						int rowsAffected = sqlcommand.ExecuteNonQuery();
						if (rowsAffected > 0)
						{
							AlertService.Success($"成功更新{rowsAffected}條");
							myAccount = "";//我的帳號
							accountOut = "";
							accountIn = "";
							accountOtherNo = "";
						}
						else
						{
							AlertService.Error("更新失敗");
						}
						SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
						sqlTransaction.Commit();
					}
				}
			}
		}
		else
		{
			m_NewAccountS = ServerData.m_NewAccountS.Where(item => item.baccountNo == account) // 根據帳號篩選
			.GroupBy(item => item.baccountNo) // 按帳號分組
			.Select(group => group.OrderBy(item => item.baccountBank)
							.ThenBy(item => item.baccountNo)
							.ThenBy(item => item.baccountDate)
							.ThenBy(item => item.baccountInsert))
			.SelectMany(sortedGroup => sortedGroup).ToArray();
			var latestRecord = m_NewAccountS[0];
			if (latestRecord.baccountDate > editDate)//最舊
			{
				string SQLString2 = "UPDATE dbo.NewAccountInfo SET [accountTotal] = @toto  WHERE   [accountBankNo] =@bank AND [accountInsert]= @accountInsert ";
				m_NewAccountRecordS = m_NewAccountS.Where(item => item.baccountDate > editDate).ToArray();
				foreach (var oldRecord in m_NewAccountRecordS)
				{
					decimal secondIn = oldRecord.baccountIn;
					decimal secondOut = oldRecord.baccountOut;
					decimal toto1 = (latestIn - latestOut + secondIn - secondOut);
					if (sqlconnection.State == System.Data.ConnectionState.Closed)
					{
						sqlconnection.Open();
						SqlCommand sqlcommand = new SqlCommand(SQLString2, sqlconnection);
						sqlcommand.Parameters.Clear();
						sqlcommand.Parameters.AddWithValue("@accountInsert", oldRecord.baccountInsert);//交易日期
						sqlcommand.Parameters.AddWithValue("@bank", bankCode);//銀行
						sqlcommand.Parameters.AddWithValue("@toto", latestIn - latestOut + secondIn - secondOut);//餘額
						int rowsAffected = sqlcommand.ExecuteNonQuery();
						if (rowsAffected > 0)
						{
							AlertService.Success($"成功更新{rowsAffected}條");
							myAccount = "";//我的帳號
							accountOut = "";
							accountIn = "";
							accountOtherNo = "";
						}
						else
						{
							AlertService.Error("更新失敗");
						}
						SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
						sqlTransaction.Commit();
					}
				}
			}
		}
	}

	public void HandleArrayWithMoreThanOneItem()//若該帳號大於2條新增
	{
		string SQLString = "INSERT INTO dbo.NewAccountInfo ([accountDate],[accountBank],[accountBankNo],[accountBranch],[accountBranchNo],[accountNo],[accountType],[accountIn],[accountOut],[accountTotal],[accountOtherNo],[accountAddress],[remark], [accountInsert],[accountUpdate]) VALUES (@accountDate,@bankName,@bankCode,@accountBranch,@accountBranchNo,@accountNo,@accountType,@accountIn,@accountOut,@toto,@accountOtherNo,@accountAddress,@remark ,@accountInsert,@accountUpdate)";
		SqlConnection sqlconnection = new SqlConnection("Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022");
		DataSet dataSet_up = new DataSet();
		var latestRecord = m_NewAccountS[0];// 最舊
		var secondRecord = m_NewAccountS[1];//第二舊
		decimal latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
		decimal latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
		decimal toto = latestIn - latestOut;
		decimal toto1 = 0;
		m_AccountRepairS = ServerData.m_AccountRepairS.Where(item => item.baccountNo == account && item.baccountBankNo == bankCode).ToArray();
		var repairbranch = m_AccountRepairS[0];
		string r_b = repairbranch.baccountBranch;
		string r_b_n = repairbranch.baccountBranchNo;
		string r_b_a = repairbranch.baccountAddress;
		if (DataVersionService.DataVersion != 1)
		{
			NewAccount[] updatedData = UpdateNewDataALL2();
			updatedData = updatedData
			.Where(item => item.baccountNo == account) // 根據帳號篩選
			.GroupBy(item => item.baccountNo) // 按帳號分組
			.Select(group => group.OrderBy(item => item.baccountBank)
								.ThenBy(item => item.baccountNo)
								.ThenBy(item => item.baccountDate)
								.ThenBy(item => item.baccountInsert))
			.SelectMany(sortedGroup => sortedGroup).ToArray();
			if (updatedData[0].baccountDate == editDate)//如果第一筆舊資料和新資料日期一樣
			{
				for (int i = 0; i < updatedData.Length; i++)
				{
					if (updatedData[i].baccountDate > editDate)
					{
						latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
						latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
						toto = updatedData[i - 1].baccountTotal + latestIn - latestOut;
						if (sqlconnection.State == System.Data.ConnectionState.Closed)
						{
							sqlconnection.Open();
							SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
							sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
							sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
							sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
							sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
							sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼							
							sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
							sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
							sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
							sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
							sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
							sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
							sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址							
							sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
							sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
							sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
							int rowsAffected = sqlcommand.ExecuteNonQuery();
							if (rowsAffected > 0)
							{
								AlertService.Success($"成功新增當前{rowsAffected}條");
								myAccount = "";//我的帳號
								accountOut = "";
								accountIn = "";
								accountOtherNo = "";
								DataVersionService.IncrementDataVersion();
							}
							else
							{
								AlertService.Error("新增失敗");
							}
							SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
							sqlTransaction.Commit();
							HandleArrayWithMoreThanOneItemUpdate(latestIn, latestOut);
							UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
							break;
						}
					}
					else//maybe所有日期都是同一個，那麼新資料會被當成最新資料 就好了 
					{
						latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
						latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
						toto1 = updatedData.Last().baccountTotal + latestIn - latestOut;
						if (sqlconnection.State == System.Data.ConnectionState.Closed)
						{
							sqlconnection.Open();
							SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
							sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
							sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
							sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
							sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
							sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼
							sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
							sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
							sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
							sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
							sqlcommand.Parameters.AddWithValue("@toto", toto1);//餘額
							sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
							sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址
							sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
							sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
							sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
							int rowsAffected = sqlcommand.ExecuteNonQuery();
							if (rowsAffected > 0)
							{
								AlertService.Success($"成功新增當前{rowsAffected}條");
								myAccount = "";//我的帳號
								accountOut = "";
								accountIn = "";
								accountOtherNo = "";
								DataVersionService.IncrementDataVersion();
							}
							else
							{
								AlertService.Error("新增失敗");
							}
							SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
							sqlTransaction.Commit();
							UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
						}
					}
				}
			}
			else if (updatedData.Last().baccountDate == editDate)//如果舊資料的最後一筆和新添加的資料日期一樣
			{
				latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
				latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
				toto1 = updatedData.Last().baccountTotal + latestIn - latestOut;
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼					
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto1);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址					
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增當前{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
				}
			}
			else if (updatedData[0].baccountDate > editDate)//新資料成為最舊
			{
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼					
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增當前{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					HandleArrayWithMoreThanOneItemUpdate(latestIn, latestOut);
					UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
				}
			}
			else if (updatedData.Last().baccountDate < editDate)//新資料依然最新
			{
				latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
				latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
				toto1 = updatedData.Last().baccountTotal + latestIn - latestOut;
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto1);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增當前{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
				}
			}
			else//新資料不舊不新，最麻煩了 QQ
			{
				for (int i = 0; i < updatedData.Length; i++)
				{
					if (updatedData[i].baccountDate > editDate)
					{
						latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
						latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
						toto = updatedData[i - 1].baccountTotal + latestIn - latestOut;
						if (sqlconnection.State == System.Data.ConnectionState.Closed)
						{
							sqlconnection.Open();
							SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
							sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
							sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
							sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
							sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
							sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼							
							sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
							sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
							sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
							sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
							sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
							sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
							sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址							
							sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
							sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
							sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
							int rowsAffected = sqlcommand.ExecuteNonQuery();
							if (rowsAffected > 0)
							{
								AlertService.Success($"成功新增當前{rowsAffected}條");
								myAccount = "";//我的帳號
								accountOut = "";
								accountIn = "";
								accountOtherNo = "";
								DataVersionService.IncrementDataVersion();
							}
							else
							{
								AlertService.Error("新增失敗");
							}
							SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
							sqlTransaction.Commit();
							HandleArrayWithMoreThanOneItemUpdate(latestIn, latestOut);
							UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
							break;
						}
					}
				}
			}
		}
		else
		{
			m_NewAccountS=ServerData.m_NewAccountS.GroupBy(item => item.baccountNo) // 按帳號分組
			.Select(group => group.OrderBy(item => item.baccountBank)
						.ThenBy(item => item.baccountNo)
						.ThenBy(item => item.baccountDate)
						.ThenBy(item => item.baccountInsert))
			.SelectMany(sortedGroup => sortedGroup).ToArray();
			if (latestRecord.baccountDate == editDate)//如果第一筆舊資料和新資料日期一樣
			{
				for (int i = 0; i < m_NewAccountS.Length; i++)
				{
					if (m_NewAccountS[i].baccountDate > editDate)
					{
						latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
						latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
						toto = m_NewAccountS[i - 1].baccountTotal + latestIn - latestOut;
						if (sqlconnection.State == System.Data.ConnectionState.Closed)
						{
							sqlconnection.Open();
							SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
							sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
							sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
							sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
							sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
							sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼							
							sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
							sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
							sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
							sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
							sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
							sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
							sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址							
							sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
							sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
							sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
							int rowsAffected = sqlcommand.ExecuteNonQuery();
							if (rowsAffected > 0)
							{
								AlertService.Success($"成功新增當前{rowsAffected}條");
								myAccount = "";//我的帳號
								accountOut = "";
								accountIn = "";
								accountOtherNo = "";
								DataVersionService.IncrementDataVersion();
							}
							else
							{
								AlertService.Error("新增失敗");
							}
							SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
							sqlTransaction.Commit();
							HandleArrayWithMoreThanOneItemUpdate(latestIn, latestOut);
							UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
							break;
						}
					}
					else
					{
						latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
						latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);

						toto1 = m_NewAccountS.Last().baccountTotal + latestIn - latestOut;
						if (sqlconnection.State == System.Data.ConnectionState.Closed)
						{
							sqlconnection.Open();
							SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
							sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
							sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
							sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
							sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
							sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼					
							sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
							sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
							sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
							sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
							sqlcommand.Parameters.AddWithValue("@toto", toto1);//餘額
							sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
							sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址					
							sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
							sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
							sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
							int rowsAffected = sqlcommand.ExecuteNonQuery();
							if (rowsAffected > 0)
							{
								AlertService.Success($"成功新增當前{rowsAffected}條");
								myAccount = "";//我的帳號
								accountOut = "";
								accountIn = "";
								accountOtherNo = "";
								DataVersionService.IncrementDataVersion();
							}
							else
							{
								AlertService.Error("新增失敗");
							}
							SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
							sqlTransaction.Commit();
							UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
						}

					}
				}
			}
			else if (m_NewAccountS.Last().baccountDate == editDate)//如果舊資料的最後一筆和新添加的資料日期一樣
			{
				latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
				latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
				toto1 = m_NewAccountS.Last().baccountTotal + latestIn - latestOut;
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼					
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto1);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增當前{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
				}
			}
			else if (latestRecord.baccountDate > editDate)//新資料成為最舊
			{
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼					
					sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增當前{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					HandleArrayWithMoreThanOneItemUpdate(latestIn, latestOut);
					UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
				}
			}
			else if (m_NewAccountS.Last().baccountDate < editDate)//新資料依然最新
			{
				latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
				latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
				toto1 = m_NewAccountS.Last().baccountTotal + latestIn - latestOut;
				if (sqlconnection.State == System.Data.ConnectionState.Closed)
				{
					sqlconnection.Open();
					SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
					sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
					sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
					sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
					sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
					sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼					
					sqlcommand.Parameters.AddWithValue("@accountNo",account);//我的帳號
					sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
					sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
					sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
					sqlcommand.Parameters.AddWithValue("@toto", toto1);//餘額
					sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
					sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址					
					sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
					sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
					sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
					int rowsAffected = sqlcommand.ExecuteNonQuery();
					if (rowsAffected > 0)
					{
						AlertService.Success($"成功新增當前{rowsAffected}條");
						myAccount = "";//我的帳號
						accountOut = "";
						accountIn = "";
						accountOtherNo = "";
						DataVersionService.IncrementDataVersion();
					}
					else
					{
						AlertService.Error("新增失敗");
					}
					SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
					sqlTransaction.Commit();
					UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
				}
			}
			else//新資料不舊不新，最麻煩了 QQ
			{
				for (int i = 0; i < m_NewAccountS.Length; i++)
				{
					if (m_NewAccountS[i].baccountDate > editDate)
					{
						latestIn = string.IsNullOrEmpty(accountIn) ? 0 : decimal.Parse(accountIn);
						latestOut = string.IsNullOrEmpty(accountOut) ? 0 : decimal.Parse(accountOut);
						toto = m_NewAccountS[i - 1].baccountTotal + latestIn - latestOut;
						if (sqlconnection.State == System.Data.ConnectionState.Closed)
						{
							sqlconnection.Open();
							SqlCommand sqlcommand = new SqlCommand(SQLString, sqlconnection);
							sqlcommand.Parameters.AddWithValue("@accountDate", editDate);//交易日期
							sqlcommand.Parameters.AddWithValue("@bankName", bankName);//銀行
							sqlcommand.Parameters.AddWithValue("@bankCode", bankCode);//銀行代碼
							sqlcommand.Parameters.AddWithValue("@accountBranch", r_b);//分行
							sqlcommand.Parameters.AddWithValue("@accountBranchNo", r_b_n);//分行代碼							
							sqlcommand.Parameters.AddWithValue("@accountNo", account);//我的帳號
							sqlcommand.Parameters.AddWithValue("@accountType", money);//付款方式
							sqlcommand.Parameters.AddWithValue("@accountIn", latestIn);//收入
							sqlcommand.Parameters.AddWithValue("@accountOut", latestOut);//支出
							sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
							sqlcommand.Parameters.AddWithValue("@accountOtherNo", accountOtherNo);//對方帳號
							sqlcommand.Parameters.AddWithValue("@accountAddress", r_b_a);//地址							
							sqlcommand.Parameters.AddWithValue("@remark", (object)remark ?? DBNull.Value);//備註
							sqlcommand.Parameters.AddWithValue("@accountInsert", datee2);//加入時間，之後排序以這個為主
							sqlcommand.Parameters.AddWithValue("@accountUpdate", datee2);//修改時間，初始都是和加入時間相同，後續會因為有修改而變動時間
							int rowsAffected = sqlcommand.ExecuteNonQuery();
							if (rowsAffected > 0)
							{
								AlertService.Success($"成功新增當前{rowsAffected}條");
								myAccount = "";//我的帳號
								accountOut = "";
								accountIn = "";
								accountOtherNo = "";
								DataVersionService.IncrementDataVersion();
							}
							else
							{
								AlertService.Error("新增失敗");
							}
							SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
							sqlTransaction.Commit();
							HandleArrayWithMoreThanOneItemUpdate(latestIn, latestOut);
							UpdateHandleEmptyArray(DateTime.Parse(datee2));//更新頁面
							break;
						}
					}
				}
			}
		}
	}

	public void HandleArrayWithMoreThanOneItemUpdate(decimal latestIn, decimal latestOut)//若該帳號大於2條更新
	{
		SqlConnection sqlconnection = new SqlConnection("Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022");
		DataSet dataSet_up = new DataSet();
		var oldRecord = m_NewAccountS[0];
		var secondRecourd = m_NewAccountS[1];
		decimal toto = latestIn - latestOut;
		decimal toto0 = 0;//最舊
		decimal toto1 = 0;
		m_NewAccountRecordS = m_NewAccountS.Where(item => item.baccountDate >= editDate).GroupBy(item => item.baccountNo) // 按帳號分組
		.Select(group => group.OrderBy(item => item.baccountBank)
								.ThenBy(item => item.baccountNo)
								.ThenBy(item => item.baccountDate)
								.ThenBy(item => item.baccountInsert))
		.SelectMany(sortedGroup => sortedGroup).ToArray();
		using (SqlConnection sqlConnection = new SqlConnection("Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022"))
		{
			if (DataVersionService.DataVersion != 1)
			{
				NewAccount[] updatedData = UpdateNewDataALL2();
				updatedData = updatedData.Where(item => item.baccountNo == account) // 根據帳號篩選
				.GroupBy(item => item.baccountNo) // 按帳號分組
				.Select(group => group.OrderBy(item => item.baccountBank)
										.ThenBy(item => item.baccountNo)
										.ThenBy(item => item.baccountDate)
										.ThenBy(item => item.baccountInsert))
				.SelectMany(sortedGroup => sortedGroup).ToArray();
				if (updatedData[0].baccountDate == editDate)//如果最舊的資料和新資料日期一樣
				{
					for (int i = 0; i < updatedData.Length; i++)
					{
						if (updatedData[i].baccountDate != editDate)
						{
							toto1 = updatedData[i - 1].baccountTotal;//新資料不舊不新，最麻煩了 QQ
							for (int j = i; j < updatedData.Length; j++)
							{
								toto1 += updatedData[j].baccountIn - updatedData[j].baccountOut;
								bank = updatedData[j].baccountBankNo;
								accountInsert = updatedData[j].baccountInsert;
								accountDate = updatedData[j].baccountDate.ToString("yyyy-MM-dd");
								UpdateAccountTotal(sqlConnection, accountDate, bank, myAccount, toto1, accountInsert);
							}
							break;
						}
					}
				}
				else if (updatedData.Last().baccountDate == editDate)//如果新資料和最後一筆資料日期一樣
				{ }
				else if (updatedData[0].baccountDate > editDate)//最舊
				{
					for (int i = 0; i < updatedData.Length; i++)
					{
						accountInsert = updatedData[i].baccountInsert;
						accountDate = updatedData[i].baccountDate.ToString("yyyy-MM-dd");
						bank = m_NewAccountS[i].baccountBankNo;
						if (i == 0)
						{
							decimal oldIn = updatedData[0].baccountIn;
							decimal oldOut = updatedData[0].baccountOut;
							toto0 = toto + oldIn - oldOut;
							UpdateAccountTotal(sqlConnection, accountDate, bank, myAccount, toto0, accountInsert);
						}
						else
						{
							toto0 += updatedData[i].baccountIn - updatedData[i].baccountOut;
							UpdateAccountTotal(sqlConnection, accountDate, bank, myAccount, toto0, accountInsert);
						}
					}

				}
				else if (updatedData.Last().baccountDate < editDate)//新資料依然最新
				{ }
				else//不新不舊
				{
					for (int i = 0; i < updatedData.Length; i++)
					{
						if (updatedData[i].baccountDate > editDate || updatedData[i].baccountDate == editDate)
						{
							toto1 = updatedData[i - 1].baccountTotal + latestIn - latestOut;//新資料不舊不新，最麻煩了 QQ

							for (int j = i; j < updatedData.Length; j++)
							{
								toto1 += updatedData[j].baccountIn - updatedData[j].baccountOut;
								bank = updatedData[j].baccountBankNo;
								accountInsert = updatedData[j].baccountInsert;
								accountDate = updatedData[j].baccountDate.ToString("yyyy-MM-dd");
								UpdateAccountTotal(sqlConnection, accountDate, bank, myAccount, toto1, accountInsert);
								break;
							}
						}
					}
				}
			}
			else
			{

				if (oldRecord.baccountDate == editDate)//如果最舊的資料和新資料日期一樣
				{
					for (int i = 0; i < m_NewAccountRecordS.Length; i++)
					{
						if (m_NewAccountRecordS[i].baccountDate == editDate)
						{
							toto1 = m_NewAccountRecordS[i].baccountTotal + latestIn - latestOut;//新資料不舊不新，最麻煩了 QQ
							for (int j = i + 1; j < m_NewAccountRecordS.Length; j++)
							{
								toto1 += m_NewAccountRecordS[j].baccountIn - m_NewAccountRecordS[j].baccountOut;
								bank = m_NewAccountRecordS[j].baccountBankNo;
								accountInsert = m_NewAccountRecordS[j].baccountInsert;
								accountDate = m_NewAccountRecordS[j].baccountDate.ToString("yyyy-MM-dd");
								UpdateAccountTotal(sqlConnection, accountDate, bank, myAccount, toto1, accountInsert);
							}
						}
					}
				}
				else if (m_NewAccountS.Last().baccountDate == editDate)//如果新資料和最後一筆資料日期一樣
				{ }
				else if (oldRecord.baccountDate > editDate)//最舊
				{
					for (int i = 0; i < m_NewAccountRecordS.Length; i++)
					{
						accountInsert = m_NewAccountRecordS[i].baccountInsert;
						accountDate = m_NewAccountS[i].baccountDate.ToString("yyyy-MM-dd");
						bank = m_NewAccountS[i].baccountBankNo;
						if (i == 0)
						{
							decimal oldIn = m_NewAccountRecordS[0].baccountIn;
							decimal oldOut = m_NewAccountRecordS[0].baccountOut;
							toto0 = toto + oldIn - oldOut;
							UpdateAccountTotal(sqlConnection, accountDate, bank, myAccount, toto0, accountInsert);
						}
						else
						{
							toto0 += m_NewAccountRecordS[i].baccountIn - m_NewAccountRecordS[i].baccountOut;
							UpdateAccountTotal(sqlConnection, accountDate, bank, myAccount, toto0, accountInsert);
						}
					}
				}
				else if (m_NewAccountS.Last().baccountDate < editDate)//新資料依然最新
				{ }
				else//不新不舊
				{
					for (int i = 0; i < m_NewAccountS.Length; i++)
					{
						if (m_NewAccountS[i].baccountDate > editDate || m_NewAccountS[i].baccountDate == editDate)
						{
							toto1 = m_NewAccountS[i - 1].baccountTotal + latestIn - latestOut;//新資料不舊不新，最麻煩了 QQ
							for (int j = i; j < m_NewAccountS.Length; j++)
							{
								toto1 += m_NewAccountS[j].baccountIn - m_NewAccountS[j].baccountOut;
								bank = m_NewAccountS[j].baccountBankNo;
								accountInsert = m_NewAccountS[j].baccountInsert;
								accountDate = m_NewAccountS[j].baccountDate.ToString("yyyy-MM-dd");
								UpdateAccountTotal(sqlConnection, accountDate, bank, myAccount, toto1, accountInsert);
								break;
							}
						}
					}
				}
			}
		}
	}

	public void UpdateAccountTotal(SqlConnection sqlConnection, string accountDate, string bankCode, string accountNo, decimal toto, DateTime accountInsert)
	{
		SqlConnection sqlconnection = new SqlConnection("Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022");
		DataSet dataSet_up = new DataSet();
		string SQLString2 = "UPDATE dbo.NewAccountInfo SET [accountTotal] = @toto  WHERE  [accountBankNo] =@bank AND [accountDate]= @accountDate  AND [accountInsert]=@accountInsert";
		if (sqlconnection.State == System.Data.ConnectionState.Closed)
		{
			sqlconnection.Open();
			SqlCommand sqlcommand = new SqlCommand(SQLString2, sqlconnection);
			sqlcommand.Parameters.Clear();
			sqlcommand.Parameters.AddWithValue("@accountDate", accountDate);//交易日期
			sqlcommand.Parameters.AddWithValue("@bank", bankCode);//銀行
			sqlcommand.Parameters.AddWithValue("@toto", toto);//餘額
			sqlcommand.Parameters.AddWithValue("@accountInsert", accountInsert);//加入時間，用於辨別
			int rowsAffected = sqlcommand.ExecuteNonQuery();
			if (rowsAffected > 0)

			{
				AlertService.Success($"成功更新{rowsAffected}條");
				myAccount = "";//我的帳號
				accountOut = "";
				accountIn = "";
				accountOtherNo = "";
			}
			else
			{
				AlertService.Error("更新失敗");
			}
			SqlTransaction sqlTransaction = sqlconnection.BeginTransaction();
			sqlTransaction.Commit();
		}
	}

	public void UpdateHandleEmptyArray(DateTime date)//更新頁面/HandleEmptyArray
	{
		m_NewAccountS = Array.Empty<NewAccount>();
		// 將 NewAccount[] 陣列轉換為 List<NewAccount>
		List<NewAccount> newList = m_NewAccountS.ToList();
		// 新資料列表
		List<NewAccount> newDataList = GetDataFromDatabase();
		// 使用 AddRange 將新資料列表添加到現有的列表中
		newList.AddRange(newDataList);
		// 將結果轉換回陣列
		// 將新資料列表添加到現有的 m_NewAccountS 中
		m_NewAccountS = newList.Where(item => item.baccountInsert.ToString("yyyy/MM/dd HH:mm:ss") == date.ToString("yyyy/MM/dd HH:mm:ss"))
										.ToArray();
	}
	public List<NewAccount> GetDataFromDatabase()
	{
		List<NewAccount> newDataList = new List<NewAccount>();
		SqlConnection sqlconnection = new SqlConnection("Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022");
		string SQLString = "SELECT ROW_NUMBER() OVER(PARTITION BY accountBank, accountNo ORDER BY  accountDate ASC)  , *FROM NewAccountInfo; ";
		string connectionString = "Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022";
		dataset = new DataSet();
		using (SqlConnection connection = new SqlConnection(connectionString))
		{
			using (SqlCommand command = new SqlCommand(SQLString, connection))
			{
				connection.Open();
				using (SqlDataReader reader = command.ExecuteReader())
				{
					while (reader.Read())
					{
						NewAccount newData = new NewAccount
							{
								// 這裡的屬性賦值根據您的資料表結構進行調整
								baccountDate = reader.GetDateTime(reader.GetOrdinal("accountDate")),
								baccountBank = reader.GetString(reader.GetOrdinal("accountBank")),
								baccountBankNo = reader.GetString(reader.GetOrdinal("accountBankNo")),
								baccountBranch = reader.GetString(reader.GetOrdinal("accountBranch")),
								baccountBranchNo = reader.GetString(reader.GetOrdinal("accountBranchNo")),
								baccountNo = reader.GetString(reader.GetOrdinal("accountNo")),
								baccountType = reader.GetString(reader.GetOrdinal("accountType")),
								baccountIn = reader.IsDBNull(reader.GetOrdinal("accountIn")) ? 0 : reader.GetDecimal(reader.GetOrdinal("accountIn")),
								baccountOut = reader.IsDBNull(reader.GetOrdinal("accountOut")) ? 0 : reader.GetDecimal(reader.GetOrdinal("accountOut")),
								baccountTotal = reader.IsDBNull(reader.GetOrdinal("accountTotal")) ? 0 : reader.GetDecimal(reader.GetOrdinal("accountTotal")),
								baccountOtherNo = reader.GetString(reader.GetOrdinal("accountOtherNo")),
								baccountAddress = reader.GetString(reader.GetOrdinal("accountAddress")),
								bremark = reader.IsDBNull(reader.GetOrdinal("remark")) ? "" : reader.GetString(reader.GetOrdinal("remark")),
								baccountInsert = reader.GetDateTime(reader.GetOrdinal("accountInsert")),
								baccountUpdate = reader.GetDateTime(reader.GetOrdinal("accountUpdate"))
								// 其他屬性...
							};
						newDataList.Add(newData);
					}
				}
			}
			return newDataList;
		}
	}
	public NewAccount[] UpdateNewDataALL2()
	{
		// 新資料列表
		List<NewAccount> newDataList = GetNewData();
		// 將新資料列表添加到現有的 m_NewAccountS 中
		m_NewAccountS = newDataList.ToArray();
		return m_NewAccountS;
	}
	public List<NewAccount> GetNewData()//再次抓取資料
	{
		List<NewAccount> newDataList = new List<NewAccount>();
		//SqlConnection sqlconnection = new SqlConnection("Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022");
		string connectionString = "Data Source=192.168.10.243\\SRV_DBSAPI,1433;Initial Catalog=Platform;User ID=sa;Password=DBSsa@2022";
		string SQLString = "SELECT ROW_NUMBER() OVER (PARTITION　BY accountBank, accountNo ORDER BY  accountDate ASC )  , * FROM NewAccountInfo; ";
		dataset = new DataSet();
		using (SqlConnection connection = new SqlConnection(connectionString))
		{
			using (SqlCommand command = new SqlCommand(SQLString, connection))
			{
				connection.Open();
				using (SqlDataReader reader = command.ExecuteReader())
				{
					while (reader.Read())
					{
						NewAccount newData = new NewAccount
							{
								// 這裡的屬性賦值根據您的資料表結構進行調整
								baccountDate = reader.GetDateTime(reader.GetOrdinal("accountDate")),
								baccountBank = reader.GetString(reader.GetOrdinal("accountBank")),
								baccountBankNo = reader.GetString(reader.GetOrdinal("accountBankNo")),
								baccountBranch = reader.GetString(reader.GetOrdinal("accountBranch")),
								baccountBranchNo = reader.GetString(reader.GetOrdinal("accountBranchNo")),
								baccountNo = reader.GetString(reader.GetOrdinal("accountNo")),
								baccountType = reader.GetString(reader.GetOrdinal("accountType")),
								baccountIn = reader.IsDBNull(reader.GetOrdinal("accountIn")) ? 0 : reader.GetDecimal(reader.GetOrdinal("accountIn")),
								baccountOut = reader.IsDBNull(reader.GetOrdinal("accountOut")) ? 0 : reader.GetDecimal(reader.GetOrdinal("accountOut")),
								baccountTotal = reader.IsDBNull(reader.GetOrdinal("accountTotal")) ? 0 : reader.GetDecimal(reader.GetOrdinal("accountTotal")),
								baccountOtherNo = reader.GetString(reader.GetOrdinal("accountOtherNo")),
								baccountAddress = reader.GetString(reader.GetOrdinal("accountAddress")),
								bremark = reader.IsDBNull(reader.GetOrdinal("remark")) ? "" : reader.GetString(reader.GetOrdinal("remark")),
								baccountInsert = reader.GetDateTime(reader.GetOrdinal("accountInsert")),
								baccountUpdate = reader.IsDBNull(reader.GetOrdinal("accountUpdate")) ? DateTime.MinValue : reader.GetDateTime(reader.GetOrdinal("accountUpdate")),
								// 其他屬性...
							};
						newDataList.Add(newData);
					}
				}
			}
			return newDataList;
		}
	}


}
